<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jewelry Price Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f3f0;
      }
      .card {
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-radius: 1.5rem;
        background-color: #ffffff;
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        appearance: textfield;
      }
      .input-field {
        border: 1px solid #d1d5db;
        padding: 0.6rem 0.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
      }
      .input-field:focus {
        border-color: #b45f06;
        outline: none;
        box-shadow: 0 0 0 3px rgba(180, 95, 6, 0.2);
      }
      .grid-3-label {
        font-size: 0.65rem;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      @media (max-width: 640px) {
        .grid-3-label {
          font-size: 0.7rem;
        }
        .grid-cols-3 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="p-4 md:p-8 min-h-screen flex items-start justify-center">
    <div class="card w-full max-w-5xl p-6 md:p-10 my-8">
      <h1
        class="text-3xl md:text-4xl font-extrabold text-[#b45f06] mb-4 text-center"
      >
        Jewelry Pricing Tool (₹)
      </h1>

      <!-- PRODUCT NAME (OPTIONAL) -->
      <div class="mb-6">
        <label
          for="productName"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Product Name (Optional)
        </label>
        <input
          type="text"
          id="productName"
          class="input-field w-full"
          placeholder="e.g. Solitaire Ring, Bridal Set"
          oninput="calculatePrice()"
        />
      </div>

      <!-- ==================== GOLD ==================== -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-6 p-4 bg-yellow-50 rounded-xl">
          <h2
            class="text-xl font-bold text-gray-800 border-b pb-2 mb-4 flex items-center"
          >
            <svg
              class="w-6 h-6 mr-2 text-yellow-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11.049 2.5a1.5 1.5 0 011.902 0l1.519 1.348a1.5 1.5 0 001.21.359l2.09-.442a1.5 1.5 0 011.59 1.73l-.442 2.09a1.5 1.5 0 00.359 1.21l1.348 1.519a1.5 1.5 0 010 1.902l-1.348 1.519a1.5 1.5 0 00-.359 1.21l.442 2.09a1.5 1.5 0 01-1.59 1.73l-2.09-.442a1.5 1.5 0 00-1.21.359l-1.519 1.348a1.5 1.5 0 01-1.902 0l-1.519-1.348a1.5 1.5 0 00-1.21-.359l-2.09.442a1.5 1.5 0 01-1.59-1.73l.442-2.09a1.5 1.5 0 00-.359-1.21l-1.348-1.519a1.5 1.5 0 010-1.902l1.348-1.519a1.5 1.5 0 00.359-1.21l-.442-2.09a1.5 1.5 0 011.59-1.73l2.09.442a1.5 1.5 0 001.21-.359l1.519-1.348z"
              ></path>
            </svg>
            Gold Component
          </h2>

          <div>
            <label
              for="currentGoldPrice"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Current 24kt Gold Price (per gram in ₹)
            </label>
            <input
              type="number"
              id="currentGoldPrice"
              value="6500"
              min="0"
              oninput="calculatePrice()"
              class="input-field w-full"
              placeholder="e.g. 6500"
            />
          </div>

          <div>
            <label
              for="goldWeight"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Required Gold Weight (grams)
            </label>
            <input
              type="number"
              id="goldWeight"
              value="5.0"
              min="0.1"
              step="0.01"
              oninput="calculatePrice()"
              class="input-field w-full"
              placeholder="e.g. 5.0"
            />
          </div>

          <div>
            <label
              for="goldKaratSelect"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Select Gold Purity (Karat) for Final Price
            </label>
            <select
              id="goldKaratSelect"
              onchange="calculatePrice()"
              class="input-field w-full bg-white"
            >
              <option value="14kt">14kt (58.33%)</option>
              <option value="18kt">18kt (75%)</option>
              <option value="10kt">10kt (41.67%)</option>
              <option value="9kt">9kt (37.5%)</option>
            </select>
          </div>

          <div
            class="p-3 bg-yellow-100 rounded-lg text-sm font-bold text-yellow-900 border border-yellow-300"
          >
            <p>
              Gold <span id="selectedKaratDisplay">14kt</span> (<span
                id="selectedGoldWeight"
                >0.00</span
              >
              gm): ₹<span id="selectedKaratPricePerGram">0.00</span> / gm
            </p>
          </div>

          <div id="goldValueOutput" class="pt-4 border-t border-yellow-200">
            <p class="text-base font-semibold text-gray-700 mb-2">
              Gold Value Breakdown (24kt Price: ₹<span id="gold24ktValue"
                >0.00</span
              >)
            </p>
            <ul class="space-y-1 text-sm text-gray-600">
              <li>9kt Value: ₹<span id="gold9ktValue">0.00</span> (37.5%)</li>
              <li>
                10kt Value: ₹<span id="gold10ktValue">0.00</span> (41.67%)
              </li>
              <li>
                14kt Value: ₹<span id="gold14ktValue">0.00</span> (58.33%)
              </li>
              <li>18kt Value: ₹<span id="gold18ktValue">0.00</span> (75%)</li>
            </ul>
          </div>
        </div>

        <!-- ==================== DIAMOND ==================== -->
        <div class="space-y-4 p-4 bg-blue-50 rounded-xl">
          <h2
            class="text-xl font-bold text-gray-800 border-b pb-2 mb-2 flex items-center"
          >
            <svg
              class="w-6 h-6 mr-2 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 3v4M3 5h4M6 17v4M17 3v4M21 5h-4M7 3H3v18h18V3h-4M5 13H3v-2h2v2zm14 0h2v-2h-2v2zm-7 0v-2h2v2h-2zm0 4h2v-2h-2v2zm0-8h2V7h-2v2zm-4 0h2V7h-2v2zm8 0h2V7h-2v2z"
              ></path>
            </svg>
            Diamond Component (Max 5 Types)
          </h2>

          <div id="diamondInputsContainer" class="space-y-3">
            <!-- Diamond Row 1 -->
            <div
              class="p-3 bg-white rounded-lg shadow-sm border border-blue-100"
              id="diamondRow1"
            >
              <h3 class="font-semibold text-sm mb-2 text-blue-700">
                Diamond Type 1
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                <div>
                  <label
                    for="carat1"
                    class="block grid-3-label text-gray-500 mb-1"
                    >Carat (per piece)</label
                  >
                  <input
                    type="number"
                    id="carat1"
                    value="0.5"
                    min="0"
                    step="0.01"
                    oninput="calculatePrice()"
                    class="input-field w-full text-sm"
                    placeholder="Carat"
                  />
                </div>
                <div>
                  <label
                    for="price1"
                    class="block grid-3-label text-gray-500 mb-1"
                    >Price/Carat (₹)</label
                  >
                  <input
                    type="number"
                    id="price1"
                    value="15000"
                    min="0"
                    oninput="calculatePrice()"
                    class="input-field w-full text-sm"
                    placeholder="Price/Carat"
                  />
                </div>
                <div>
                  <label
                    for="qty1"
                    class="block grid-3-label text-gray-500 mb-1"
                    >Quantity</label
                  >
                  <input
                    type="number"
                    id="qty1"
                    value="10"
                    min="0"
                    step="1"
                    oninput="calculatePrice()"
                    class="input-field w-full text-sm"
                    placeholder="Qty"
                  />
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2 font-medium">
                Cost (incl. margin): ₹<span id="cost1">0.00</span>
              </p>
            </div>
            <!-- Rows 2-5 will be cloned via JS -->
          </div>

          <button
            id="addDiamondButton"
            onclick="addDiamondRow()"
            class="w-full py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out flex items-center justify-center space-x-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <span>Add Another Diamond Type</span>
          </button>

          <div
            id="diamondSummary"
            class="pt-4 border-t border-blue-200 text-sm text-gray-600 space-y-1"
          >
            <p>
              Total Carats (All Types):
              <span id="totalCarats" class="font-medium">0.00</span>
            </p>
            <p>
              Total Base Diamond Value: ₹<span
                id="totalBaseDiamondValue"
                class="font-medium"
                >0.00</span
              >
            </p>
            <p class="font-semibold text-base text-blue-800">
              Final Diamond Price (incl. Margin): ₹<span id="finalDiamondPrice"
                >0.00</span
              >
            </p>
          </div>
        </div>
      </div>

      <!-- ==================== PROFIT & COST CONFIG ==================== -->
      <div class="mt-8 p-6 bg-green-50 rounded-xl border border-green-200">
        <h2
          class="text-xl font-bold text-gray-800 border-b pb-2 mb-4 flex items-center text-green-700"
        >
          <svg
            class="w-6 h-6 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2h-2m0 0h-2m-2 0h2m0 0v-2m0 2v2m0 0h2m0 0h2m-2 0v2m0 0V8m0 4h2m0 0h2m-2 0v2m0 0V8m0 4h2m0 0h2m-2 0v2m0 0V8m-2 8c0 1.657-1.343 3-3 3s-3-1.343-3-3m0 0V8m0 4h2m0 0h2m-2 0v2m0 0V8"
            ></path>
          </svg>
          Profit & Cost Configuration
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="space-y-3 p-4 bg-white rounded-lg shadow-sm">
            <h3 class="font-semibold text-sm text-gray-700 border-b pb-2">
              Gold Making Charges (Rates per Gram)
            </h3>
            <div>
              <label
                for="makingChargeRateHigh"
                class="block text-xs font-medium text-gray-500 mb-1"
              >
                Rate for Gold Weight ≤ 2g (₹/gram)
              </label>
              <input
                type="number"
                id="makingChargeRateHigh"
                value="950"
                min="0"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 950"
              />
            </div>
            <div>
              <label
                for="makingChargeRateLow"
                class="block text-xs font-medium text-gray-500 mb-1"
              >
                Rate for Gold Weight > 2g (₹/gram)
              </label>
              <input
                type="number"
                id="makingChargeRateLow"
                value="700"
                min="0"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 700"
              />
            </div>
            <div class="pt-2 border-t border-gray-100">
              <label
                for="makingChargeMargin"
                class="block text-xs font-medium text-gray-500 mb-1 font-bold text-green-700"
              >
                Profit Margin on Making Charges (%)
              </label>
              <input
                type="number"
                id="makingChargeMargin"
                value="30"
                min="0"
                max="1000"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 30"
              />
            </div>
          </div>

          <div class="space-y-3 p-4 bg-white rounded-lg shadow-sm">
            <h3 class="font-semibold text-sm text-gray-700 border-b pb-2">
              Diamond Profit Margin (Percentage)
            </h3>
            <div>
              <label
                for="diamondMarginSmall"
                class="block text-xs font-medium text-gray-500 mb-1"
              >
                Margin for Small Stones (&lt; 1.0ct / piece) (%)
              </label>
              <input
                type="number"
                id="diamondMarginSmall"
                value="50"
                min="0"
                max="1000"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 50"
              />
            </div>
            <div>
              <label
                for="diamondMarginLarge"
                class="block text-xs font-medium text-gray-500 mb-1"
              >
                Margin for Large Stones (≥ 1.0ct / piece) (%)
              </label>
              <input
                type="number"
                id="diamondMarginLarge"
                value="80"
                min="0"
                max="1000"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 80"
              />
            </div>
          </div>

          <!-- New Custom Fixed Costs -->
          <div class="space-y-3 p-4 bg-white rounded-lg shadow-sm">
            <h3 class="font-semibold text-sm text-gray-700 border-b pb-2">
              Custom Fixed Costs
            </h3>
            <div>
              <label
                for="courierCost"
                class="block text-xs font-medium text-gray-500 mb-1"
              >
                Courier Cost (₹)
              </label>
              <input
                type="number"
                id="courierCost"
                value="700"
                min="0"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 700"
              />
            </div>
            <div>
              <label
                for="packagingCost"
                class="block text-xs font-medium text-gray-500 mb-1"
              >
                Packaging Cost (₹)
              </label>
              <input
                type="number"
                id="packagingCost"
                value="150"
                min="0"
                oninput="calculatePrice()"
                class="input-field w-full text-sm"
                placeholder="e.g. 150"
              />
            </div>
            <div
              class="pt-2 border-t border-gray-100 text-sm font-bold text-green-700"
            >
              Total Fixed (Courier + Pkg): ₹<span id="totalBaseFixed"
                >850.00</span
              >
            </div>
          </div>
        </div>

        <div class="mt-4 p-3 bg-green-100 rounded-lg text-sm text-green-800">
          <p class="text-xs font-semibold text-green-800">
            IGI Certification Charge: ₹900.00 (Applies if total diamond weight
            &lt; 1.0ct)
          </p>
        </div>
      </div>

      <!-- ==================== INTERNAL COST SUMMARY ==================== -->
      <div class="mt-8 p-6 bg-gray-50 rounded-xl">
        <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">
          Cost Summary & Final Price
        </h2>

        <div class="space-y-3 pt-4 border-t border-gray-200">
          <div class="flex justify-between items-center text-lg">
            <span class="font-semibold text-gray-700">
              1. Total Gold Value (
              <span id="selectedKaratSummary">14kt</span>,
              <span id="goldWeightSummary">0.00</span> gm ):
            </span>
            <span class="font-bold text-yellow-800"
              >₹<span id="totalGoldCost">0.00</span></span
            >
          </div>
          <div class="flex justify-between items-center text-lg">
            <span class="font-semibold text-gray-700"
              >2. Total Diamond Value (incl. Margin):</span
            >
            <span class="font-bold text-blue-800"
              >₹<span id="totalDiamondCost">0.00</span></span
            >
          </div>
          <div class="flex justify-between items-center text-lg">
            <span class="font-semibold text-gray-700">3. Making Charges:</span>
            <span class="font-bold text-gray-800">
              ₹<span id="totalMakingCharges">0.00</span> (<span
                id="makingPercent"
                >0.0</span
              >%)
            </span>
          </div>

          <div class="space-y-1">
            <div class="flex justify-between items-center text-lg">
              <span class="font-semibold text-gray-700"
                >4. Total Fixed Costs:</span
              >
              <span class="font-bold text-gray-800"
                >₹<span id="totalFixedCost">0.00</span></span
              >
            </div>
            <ul
              class="ml-4 text-xs text-gray-500 space-y-0.5"
              id="fixedCostBreakdown"
            ></ul>
          </div>

          <div class="h-px bg-gray-300 my-4"></div>

          <div class="flex justify-between items-center text-xl">
            <span class="font-bold text-gray-800">Subtotal:</span>
            <span class="font-extrabold text-gray-900"
              >₹<span id="subtotalBeforeGST">0.00</span></span
            >
          </div>

          <div class="flex justify-between items-center text-xl">
            <span class="font-bold text-red-600">3% GST:</span>
            <span class="font-extrabold text-red-700"
              >₹<span id="gstValue">0.00</span></span
            >
          </div>

          <div
            class="flex justify-between items-center text-2xl p-3 bg-[#b45f06] text-white rounded-lg mt-4"
          >
            <span class="font-bold">FINAL JEWELRY PRICE:</span>
            <span class="font-extrabold"
              >₹<span id="finalTotalPrice">0.00</span></span
            >
          </div>
        </div>
      </div>
      <!-- ==================== OPTIONAL IMAGE UPLOAD ==================== -->
      <div class="mt-8 p-6 bg-amber-50 rounded-xl border border-amber-200">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
          Product Image (Optional)
        </h2>
        <div class="flex flex-col items-center">
          <input
            type="file"
            id="productImageInput"
            accept="image/*"
            class="mb-4"
          />
          <div id="imagePreviewContainer" class="max-w-md w-full hidden">
            <img
              id="productImagePreview"
              class="rounded-lg shadow-lg max-h-96 w-full object-contain"
              alt="Product preview"
            />
          </div>
          <p class="text-sm text-gray-600 mt-2">
            Upload a design/photo of the jewellery (will appear in the quote &
            PDF)
          </p>
        </div>
      </div>
      <!-- ==================== CUSTOMER QUOTE ==================== -->
      <div
        class="mt-8 p-6 bg-yellow-50 rounded-xl border-4 border-dashed border-gray-200"
      >
        <h2
          class="text-xl font-bold text-gray-800 border-b pb-2 mb-4 text-center text-[#b45f06] flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          Customer Final Quote Summary
        </h2>

        <div class="space-y-3 pt-4">
          <!-- Product row only shown if filled -->
          <div
            id="customerProductRow"
            class="flex justify-between items-center text-lg hidden"
          >
            <span class="font-semibold text-gray-700">Product:</span>
            <span
              class="font-bold text-gray-800"
              id="customerProductName"
            ></span>
          </div>

          <div class="flex justify-between items-center text-lg">
            <span class="font-semibold text-gray-700">
              1. Gold Value (
              <span id="customerKaratSummary">14kt</span>,
              <span id="customerGoldWeightSummary">0.00</span> gm ):
            </span>
            <span class="font-bold text-yellow-800"
              >₹<span id="customerGoldCost">0.00</span></span
            >
          </div>

          <div class="flex justify-between items-center text-lg">
            <span class="font-semibold text-gray-700">
              2. Diamond Value (<span id="customerDiamondCarats">-</span>):
            </span>
            <span class="font-bold text-blue-800"
              >₹<span id="customerDiamondWithFixed">0.00</span></span
            >
          </div>

          <div class="flex justify-between items-center text-lg">
            <span class="font-semibold text-gray-700"
              >3. Making Charges(<span id="customerMakingPercent">0.0</span
              >%):</span
            >
            <span class="font-bold text-gray-800"
              >₹<span id="customerMakingCharges">0.00</span>
            </span>
          </div>

          <div class="h-px bg-gray-300 my-4"></div>

          <div class="flex justify-between items-center text-xl">
            <span class="font-bold text-gray-800">Subtotal:</span>
            <span class="font-extrabold text-gray-900"
              >₹<span id="customerSubtotalBeforeGST">0.00</span></span
            >
          </div>

          <div class="flex justify-between items-center text-xl">
            <span class="font-bold text-red-600">3% GST:</span>
            <span class="font-extrabold text-red-700"
              >₹<span id="customerGstValue">0.00</span></span
            >
          </div>

          <div
            class="flex justify-between items-center text-xl p-3 bg-gray-800 text-white rounded-lg mt-4"
          >
            <span class="font-semibold text-base">FINAL CUSTOMER PRICE:</span>
            <span class="font-bold"
              >₹<span id="customerFinalTotalPrice">0.00</span></span
            >
          </div>
        </div>
      </div>

      <p class="text-xs text-center text-gray-400 mt-6">
        Calculations use the selected gold purity for the final total.
      </p>

      <!-- ==================== DOWNLOAD PDF BUTTON ==================== -->
      <div class="mt-6 text-center">
        <button
          id="downloadPdfButton"
          onclick="downloadPDF()"
          class="inline-flex items-center px-6 py-3 bg-[#b45f06] hover:bg-[#8b4a05] text-white font-bold rounded-lg shadow-lg transition duration-150 ease-in-out space-x-2"
        >
          Download PDF
        </button>
      </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
      // ---------- Utility ----------
      const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;
      const formatCurrency = (value) =>
        value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

      // ---------- Constants ----------
      const GOLD_PURITY = {
        "24kt": 1.0,
        "18kt": 0.75,
        "14kt": 14 / 24,
        "10kt": 10 / 24,
        "9kt": 0.375,
      };
      const IGI_CHARGE = 900;
      const GST_RATE = 0.03;
      const MAX_DIAMONDS = 5;
      let diamondCount = 1;

      // ---------- Image Preview ----------
      document
        .getElementById("productImageInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const previewContainer = document.getElementById(
            "imagePreviewContainer"
          );
          const previewImg = document.getElementById("productImagePreview");

          if (file) {
            const reader = new FileReader();
            reader.onload = function (ev) {
              previewImg.src = ev.target.result;
              previewContainer.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
          } else {
            previewContainer.classList.add("hidden");
            previewImg.src = "";
          }
        });

      // ---------- Add Diamond Row ----------
      function addDiamondRow() {
        if (diamondCount < MAX_DIAMONDS) {
          diamondCount++;
          const row = document.getElementById(`diamondRow${diamondCount}`);
          if (row) row.classList.remove("hidden");
          document.getElementById(`carat${diamondCount}`).focus();
        }
        if (diamondCount === MAX_DIAMONDS)
          document.getElementById("addDiamondButton").classList.add("hidden");
        calculatePrice();
      }

      // ---------- Main Calculation ----------
      function calculatePrice() {
        // ----- Gold -----
        const goldPrice24 = getNum("currentGoldPrice");
        const goldWeight = getNum("goldWeight");
        const selectedKarat = document.getElementById("goldKaratSelect").value;

        const goldValue24kt = goldPrice24 * goldWeight;
        const goldValues = {};
        for (const kt in GOLD_PURITY)
          goldValues[kt] = goldValue24kt * GOLD_PURITY[kt];
        const totalGoldCost = goldValues[selectedKarat];

        // ----- Making Charges -----
        const rateHigh = getNum("makingChargeRateHigh");
        const rateLow = getNum("makingChargeRateLow");
        const makingMarginPct = getNum("makingChargeMargin") / 100;

        const makingRate =
          goldWeight > 2 ? rateLow : goldWeight > 0 ? rateHigh : 0;
        const baseMaking = goldWeight * makingRate;
        const totalMakingCharges = baseMaking * (1 + makingMarginPct);

        // ----- Diamonds -----
        const marginSmallPct = getNum("diamondMarginSmall") / 100;
        const marginLargePct = getNum("diamondMarginLarge") / 100;

        let totalCarats = 0,
          totalBaseDiamond = 0,
          finalDiamondPrice = 0;
        const caratList = [];

        for (let i = 1; i <= diamondCount; i++) {
          const carat = getNum(`carat${i}`);
          const price = getNum(`price${i}`);
          const qty = getNum(`qty${i}`);

          if (carat > 0 && price > 0 && qty > 0) {
            const rowCarats = carat * qty;
            const baseRow = rowCarats * price;
            const marginPct = carat >= 1 ? marginLargePct : marginSmallPct;
            const rowFinal = baseRow * (1 + marginPct);

            totalCarats += rowCarats;
            totalBaseDiamond += baseRow;
            finalDiamondPrice += rowFinal;

            caratList.push(qty + "-" + carat.toFixed(2) + "ct");

            document.getElementById(`cost${i}`).textContent =
              formatCurrency(rowFinal);
          } else {
            document.getElementById(`cost${i}`).textContent = "0.00";
          }
        }

        // ----- Custom Fixed Costs -----
        const courierCost = getNum("courierCost");
        const packagingCost = getNum("packagingCost");
        const baseFixedCost = courierCost + packagingCost;

        document.getElementById("totalBaseFixed").textContent =
          formatCurrency(baseFixedCost);

        // ----- IGI -----
        let igiApplied = 0;
        let fixedBreakdown = `<li>Courier: ₹${formatCurrency(
          courierCost
        )}</li><li>Packaging: ₹${formatCurrency(packagingCost)}</li>`;
        if (totalCarats > 0 && totalCarats < 1) {
          igiApplied = IGI_CHARGE;
          fixedBreakdown += `<li class="text-green-600 font-semibold">IGI Certification (Carat &lt; 1.0): ₹${formatCurrency(
            IGI_CHARGE
          )}</li>`;
        } else if (totalCarats >= 1) {
          fixedBreakdown += `<li class="text-red-500 italic">IGI Not Applied (Carat ≥ 1.0)</li>`;
        } else {
          fixedBreakdown += `<li>IGI Not Applicable (No Diamonds)</li>`;
        }
        const totalFixedCost = baseFixedCost + igiApplied;

        // ----- Totals -----
        const subtotal =
          totalGoldCost +
          finalDiamondPrice +
          totalMakingCharges +
          totalFixedCost;
        const gst = subtotal * GST_RATE;
        const finalTotal = subtotal + gst;

        // ----- Making % of Gold -----
        let makingPct = 0;
        if (totalGoldCost > 0)
          makingPct = (totalMakingCharges / totalGoldCost) * 100;

        // ----- INTERNAL DISPLAY -----
        document.getElementById("gold24ktValue").textContent =
          formatCurrency(goldValue24kt);
        ["9kt", "10kt", "14kt", "18kt"].forEach((k) => {
          document.getElementById(`gold${k}Value`).textContent = formatCurrency(
            goldValues[k]
          );
        });

        document.getElementById("selectedKaratDisplay").textContent =
          selectedKarat;
        document.getElementById("selectedGoldWeight").textContent =
          goldWeight.toFixed(2);
        document.getElementById("selectedKaratPricePerGram").textContent =
          formatCurrency(goldPrice24 * GOLD_PURITY[selectedKarat]);
        document.getElementById("selectedKaratSummary").textContent =
          selectedKarat;
        document.getElementById("goldWeightSummary").textContent =
          goldWeight.toFixed(2);
        document.getElementById("totalGoldCost").textContent =
          formatCurrency(totalGoldCost);

        document.getElementById("totalCarats").textContent =
          totalCarats.toFixed(2);
        document.getElementById("totalBaseDiamondValue").textContent =
          formatCurrency(totalBaseDiamond);
        document.getElementById("finalDiamondPrice").textContent =
          formatCurrency(finalDiamondPrice);
        document.getElementById("totalDiamondCost").textContent =
          formatCurrency(finalDiamondPrice);

        document.getElementById("totalMakingCharges").textContent =
          formatCurrency(totalMakingCharges);
        document.getElementById("makingPercent").textContent =
          makingPct.toFixed(1);
        document.getElementById("customerMakingPercent").textContent =
          makingPct.toFixed(1);

        document.getElementById("fixedCostBreakdown").innerHTML =
          fixedBreakdown;
        document.getElementById("totalFixedCost").textContent =
          formatCurrency(totalFixedCost);

        document.getElementById("subtotalBeforeGST").textContent =
          formatCurrency(subtotal);
        document.getElementById("gstValue").textContent = formatCurrency(gst);
        document.getElementById("finalTotalPrice").textContent =
          formatCurrency(finalTotal);

        // ----- CUSTOMER DISPLAY -----
        document.getElementById("customerKaratSummary").textContent =
          selectedKarat;
        document.getElementById("customerGoldWeightSummary").textContent =
          goldWeight.toFixed(2);
        document.getElementById("customerGoldCost").textContent =
          formatCurrency(totalGoldCost);
        document.getElementById("customerMakingCharges").textContent =
          formatCurrency(totalMakingCharges);

        const diamondWithFixed = finalDiamondPrice + baseFixedCost + igiApplied;
        document.getElementById("customerDiamondWithFixed").textContent =
          formatCurrency(diamondWithFixed);

        const caratListStr = caratList.length > 0 ? caratList.join(", ") : "-";
        document.getElementById("customerDiamondCarats").textContent =
          caratListStr;

        document.getElementById("customerSubtotalBeforeGST").textContent =
          formatCurrency(subtotal);
        document.getElementById("customerGstValue").textContent =
          formatCurrency(gst);
        document.getElementById("customerFinalTotalPrice").textContent =
          formatCurrency(finalTotal);

        // ----- PRODUCT NAME -----
        const productInputEl = document.getElementById("productName");
        if (productInputEl) {
          const productName = productInputEl.value.trim();
          const productRow = document.getElementById("customerProductRow");
          const productNameSpan = document.getElementById(
            "customerProductName"
          );

          if (productName.length > 0) {
            productRow.classList.remove("hidden");
            productNameSpan.textContent = productName;
          } else {
            productRow.classList.add("hidden");
            productNameSpan.textContent = "";
          }
        }
      }

      // ---------- Download PDF ----------
      async function downloadPDF() {
        const button = document.getElementById("downloadPdfButton");
        const originalText = button.innerHTML;

        button.innerHTML =
          '<svg class="animate-spin h-5 w-5 mx-auto" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        button.disabled = true;

        try {
          const element = document.querySelector(".card");

          // Temporarily replace inputs/selects with divs for clean PDF rendering
          const inputs = element.querySelectorAll("input, select");
          const inputReplacements = [];

          inputs.forEach((input) => {
            const div = document.createElement("div");
            div.className = input.className;
            div.style.cssText = window.getComputedStyle(input).cssText;
            div.style.border = "1px solid #d1d5db";
            div.style.padding = "0.6rem 0.5rem";
            div.style.borderRadius = "0.5rem";
            div.style.backgroundColor = "#ffffff";
            div.style.minHeight = "2.5rem";
            div.style.display = "flex";
            div.style.alignItems = "center";

            let displayText = "";
            if (input.tagName === "SELECT") {
              displayText = input.options[input.selectedIndex]?.text || "";
            } else {
              displayText = input.value || "";
            }
            div.textContent = displayText;

            inputReplacements.push({ original: input, replacement: div });
            input.parentNode.replaceChild(div, input);
          });

          const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff",
            windowWidth: element.scrollWidth,
            windowHeight: element.scrollHeight,
          });

          // Restore inputs
          inputReplacements.forEach(({ original, replacement }) => {
            replacement.parentNode.replaceChild(original, replacement);
          });

          const imgWidth = 210;
          const pageHeight = 297;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;

          const imgData = canvas.toDataURL("image/png");
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p", "mm", "a4");
          let position = 0;

          pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          const productName = document
            .getElementById("productName")
            .value.trim();
          const filename = productName
            ? `${productName.replace(/[^a-z0-9]/gi, "_")}_Jewelry_Quote.pdf`
            : "Jewelry_Price_Quote.pdf";

          pdf.save(filename);
        } catch (error) {
          console.error("Error generating PDF:", error);
          alert("Error generating PDF. Please try again.");
        } finally {
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }

      // ---------- Init ----------
      window.onload = function () {
        const sel = document.getElementById("goldKaratSelect");
        if (!sel.value) sel.value = "14kt";

        // Build hidden diamond rows (2-5)
        for (let i = 2; i <= 5; i++) {
          const row1 = document.getElementById("diamondRow1").cloneNode(true);
          row1.id = `diamondRow${i}`;
          row1.classList.add("hidden");
          row1.querySelectorAll("[id]").forEach((el) => {
            const oldId = el.id;
            const newId = oldId.replace(/\d+$/, i);
            el.id = newId;
            if (el.tagName === "LABEL") el.setAttribute("for", newId);
          });
          const heading = row1.querySelector("h3");
          if (heading) heading.textContent = `Diamond Type ${i}`;
          row1.querySelectorAll("input").forEach((inp) => (inp.value = "0"));
          row1.querySelector("span[id^='cost']").textContent = "0.00";
          document.getElementById("diamondInputsContainer").appendChild(row1);
        }

        calculatePrice();
      };
    </script>
  </body>
</html>
